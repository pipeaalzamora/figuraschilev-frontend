<h2 mat-dialog-title>
    {{ isEditing ? 'Editar' : 'Nueva' }} Figura
</h2>

<mat-dialog-content>
    <form [formGroup]="form" class="figura-form">
        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombre" placeholder="Ej: Goku Super Saiyan" autocomplete="off" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcionLarga" rows="3"
                placeholder="Descripción de la figura"></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
            <mat-label>Historia</mat-label>
            <textarea matInput formControlName="historia" rows="3" placeholder="¿Cómo la conseguiste?"></textarea>
        </mat-form-field>

        <div class="row">
            <mat-form-field appearance="outline">
                <mat-label>Precio (CLP)</mat-label>
                <span matTextPrefix>$&nbsp;</span>
                <input matInput [value]="precioFormateado()" (input)="onPrecioInput($event)" placeholder="0"
                    autocomplete="off" />
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Fecha de compra</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="fechaCompra" />
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
            </mat-form-field>
        </div>

        <div class="row">
            <mat-form-field appearance="outline">
                <mat-label>Lugar de compra</mat-label>
                <mat-select formControlName="lugarCompra">
                    <mat-optgroup label="Ferias - Villa Alemana">
                        <mat-option value="Feria Villa Alemana Centro">Feria Villa Alemana Centro</mat-option>
                        <mat-option value="Feria Las Américas">Feria Las Américas</mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Ferias - Quilpué">
                        <mat-option value="Feria Quilpué Centro">Feria Quilpué Centro</mat-option>
                        <mat-option value="Feria El Belloto">Feria El Belloto</mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Ferias - Viña del Mar">
                        <mat-option value="Feria Viña del Mar">Feria Viña del Mar</mat-option>
                        <mat-option value="Feria Forestal">Feria Forestal</mat-option>
                        <mat-option value="Feria Santa Inés">Feria Santa Inés</mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Ferias - Valparaíso">
                        <mat-option value="Feria Valparaíso">Feria Valparaíso</mat-option>
                        <mat-option value="Persa Barón">Persa Barón</mat-option>
                        <mat-option value="Feria Placeres">Feria Placeres</mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Marketplace">
                        <mat-option value="MercadoLibre">MercadoLibre</mat-option>
                        <mat-option value="Facebook Marketplace">Facebook Marketplace</mat-option>
                        <mat-option value="Yapo">Yapo</mat-option>
                        <mat-option value="AliExpress">AliExpress</mat-option>
                        <mat-option value="Amazon">Amazon</mat-option>
                        <mat-option value="Tienda Online">Tienda Online</mat-option>
                    </mat-optgroup>
                    <mat-optgroup label="Otro">
                        <mat-option value="Otro">Otro</mat-option>
                    </mat-optgroup>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Categoría</mat-label>
                <mat-select formControlName="categoria">
                    <mat-option value="">Sin categoría</mat-option>
                    <mat-option value="Anime">Anime</mat-option>
                    <mat-option value="Serie">Serie</mat-option>
                    <mat-option value="Película">Película</mat-option>
                    <mat-option value="Videojuegos">Videojuegos</mat-option>
                    <mat-option value="Superhéroes">Superhéroes</mat-option>
                    <mat-option value="Animados">Animados</mat-option>
                    <mat-option value="Antigüedades">Antigüedades</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <!-- Imágenes -->
        <div class="image-upload-section">
            <label>Imágenes (la primera será la principal) *</label>
            <div class="images-grid">
                @for (img of imagePreviews(); track img.id; let i = $index) {
                <div class="image-item" [class.is-main]="i === 0" draggable="true"
                    (dragstart)="onImageDragStart($event, i)" (dragover)="onImageDragOver($event)"
                    (drop)="onImageDrop($event, i)">
                    <img [src]="img.url" alt="Imagen" />
                    @if (i === 0) {
                    <span class="main-badge">Principal</span>
                    }
                    <div class="image-actions">
                        @if (i > 0) {
                        <button mat-icon-button (click)="moveImageToFirst(i)" type="button" class="move-btn"
                            title="Hacer principal">
                            <mat-icon>star</mat-icon>
                        </button>
                        }
                        <button mat-icon-button (click)="removeImage(i)" type="button" class="remove-btn">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                    @if (img.uploading) {
                    <div class="upload-overlay">
                        <mat-spinner diameter="30"></mat-spinner>
                    </div>
                    }
                </div>
                }
                <div class="upload-area" [class.drag-over]="isDragging()" (click)="imageInput.click()"
                    (dragover)="onDragOver($event)" (dragleave)="onDragLeave()" (drop)="onDrop($event)">
                    <mat-icon>add_photo_alternate</mat-icon>
                    <span>Agregar</span>
                </div>
            </div>
            <input #imageInput type="file" accept="image/jpeg,image/png,image/webp" hidden multiple
                (change)="onImagesSelect($event)" />
            <small class="hint">Arrastra para reordenar. JPG, PNG, WebP (máx 5MB c/u)</small>
        </div>

        <mat-checkbox formControlName="destacado">Marcar como destacada</mat-checkbox>
    </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancelar</button>
    <button mat-raised-button color="primary"
        [disabled]="form.invalid || saving() || isUploading() || imagePreviews().length === 0" (click)="save()">
        {{ saving() ? 'Guardando...' : 'Guardar' }}
    </button>
</mat-dialog-actions>